# Changelog

## [v4.20.3] - 2026-02-01

### 显示优化
- **商城价格显示含税总价**
  - 商城现在显示含税后的实际购买价格
  - 格式：`xxx 💰 (含N%税)`
  - 税率说明：道具价格位数 = 税率%（如3位数=3%税率）

---

## [v4.20.2] - 2026-02-01

### Bug修复
- **修复牛牛盾牌批量购买只扣钱不加护盾的问题**
  - 问题：批量购买牛牛盾牌时，金币被扣除但护盾次数未增加
  - 原因：牛牛盾牌错误地进入了简单道具批量购买分支（该分支不处理护盾）
  - 修复：排除牛牛盾牌，让其走专用的`is_dunpai`分支

---

## [v4.20.1] - 2026-02-01

### 优化调整
- **牛牛排行** 指令支持参数：`牛牛排行 长度` / `牛牛排行 金币`（默认长度）

---

## [v4.19.10] - 2026-02-01

### 数值调整
- **金币消失档位大幅削弱**（大自爆/黑洞/月牙天冲）
  - 1档：5-10% → **1-5%**，概率 85% → **92%**
  - 2档：15-25%，概率 12% → **5%**
  - 3档、4档不变

---

## [v4.19.9] - 2026-02-01

### 数值调整
- **抢劫金额比例大幅削弱**
  - 1档：5-15% → **1-5%**，概率 40% → **75%**
  - 2档：20-30% → **6-12%**，概率 30% → **15%**
  - 3档：35-50% → **13-20%**，概率 20% → **7%**
  - 4档：55-70% → **21-30%**，概率 10% → **3%**

---

## [v4.19.8] - 2026-01-31

### Bug修复
- **修复比划赌注税收计算报错** 🐛 BUG FIX
  - 问题：比划下注时报错 `'NiuniuPlugin' object has no attribute 'stock'`
  - 原因：使用了未初始化的 `self.stock`
  - 修复：改用 `NiuniuStock.get()` 获取单例实例
  - 📍 位置：main.py:2201, 2209, 2339, 2351

---

## [v4.19.7] - 2026-01-31

### Bug修复
- **修复比划赌注验证失败仍消耗CD** 🐛 BUG FIX
  - 问题：赌注超限或金币不足时，CD已被消耗
  - 原因：冷却更新在赌注验证之前执行
  - 修复：把冷却更新移到验证通过之后
  - 📍 位置：main.py:1994-2024

### 功能调整
- **删除比划赌注上限** ⚖️ BALANCE
  - 删除10000金币的赌注上限
  - 只保留最小值限制（10金币）
  - 📍 位置：main.py:2006-2008

---

## [v4.19.6] - 2026-01-31

### Bug修复
- **修复打胶道具消耗报错** 🐛 BUG FIX
  - 问题：打胶时报错 `'NiuniuPlugin' object has no attribute 'consume_item'`
  - 原因：`consume_item`方法在NiuniuShop类中，但effects引用的是NiuniuPlugin
  - 修复：在NiuniuPlugin中添加代理方法
  - 📍 位置：main.py:220-222

---

## [v4.19.5] - 2026-01-31

### 数值调整
- **金币消失触发概率调整** ⚖️ BALANCE
  - 触发概率：75% → 50%
  - 📍 位置：niuniu_config.py:709

---

## [v4.19.4] - 2026-01-31

### 性能优化
- **黑洞/大自爆/月牙天冲 性能优化** ⚡ PERFORMANCE
  - 问题：这些道具处理10+受害者时响应缓慢
  - 原因：`_apply_coin_vanish` 每个受害者都重复加载文件（50+次I/O）
  - 修复：传入已加载的 group_data，批量处理金币变化
  - 📍 位置：niuniu_shop.py:356-434, 1604-1626, 1682-1700, 1765-1783

### 数值调整
- **金币消失系统概率调整** ⚖️ BALANCE
  - 大幅降低高损失档位的触发概率
  - 新概率分布：
    - 5-10%损失：85%（绝大部分）
    - 15-25%损失：12%
    - 30-40%损失：2%（极罕见）
    - 45-50%损失：1%（几乎不会）
  - 📍 位置：niuniu_config.py:712-716

---

## [v4.19.3] - 2026-01-31

### Bug修复
- **修复 PLUGIN_DIR 路径错误** 🐛 BUG FIX
  - 问题：插件安装后会创建错误的目录 `astrbot_plugin_niuniu`
  - 修复：路径修正为 `astrbot_plugin_niuniu_plus`
  - 📍 位置：niuniu_config.py:7

---

## [v4.19.2] - 2026-01-31

### Bug修复
- **修复道具购买 UnboundLocalError** 🐛 CRITICAL BUG FIX
  - 问题：购买道具时报错 `cannot access local variable 'EffectContext'` 或 `'stock_hook'`
  - 原因：条件块内的本地导入导致 Python 将变量标记为局部变量
  - 修复：删除多余的本地导入（顶部已有全局导入）
  - 📍 位置：niuniu_shop.py:1039, 1149

---

## [v4.19.1] - 2026-01-31

### Bug修复
- **修复被动道具购买消费税重复显示** 🐛 BUG FIX
  - 问题：购买被动道具（如致命节奏）时，消费税显示两次（不同税率）
  - 原因：被动道具处理后没有return，继续执行到单次购买通用逻辑
  - 修复：添加yield和return，确保被动道具购买后正确返回
  - 📍 位置：niuniu_shop.py:842-846

### 文档更新
- **更新牛牛菜单** 📝 DOCUMENTATION
  - 添加订阅系统相关命令
    - 牛牛订阅商店
    - 牛牛订阅 <编号> [天数]
    - 牛牛取消订阅 <编号>
  - 添加股市梭哈功能说明
  - 重新组织菜单结构（基础功能/商城系统/经济系统/管理员指令）
  - 📍 位置：niuniu_game_texts.yml:929-948

---

## [v4.19.0] - 2026-01-31

### 性能优化
- **比划比划性能大幅提升** ⚡ PERFORMANCE
  - 🚀 实现命令级数据缓存系统
  - 📉 减少文件I/O：150+次 → 2次（1读+1写）
  - ⏱️ 预计性能提升：50-75倍（1.5s → 20-30ms）
  - 🎯 修复围观群友导致的性能灾难（50人 = 50次写入）
  - 📍 位置：main.py:49-52, 153-180, 1908-2714

### 实现细节
- **缓存机制**
  - `_begin_data_cache_async()`: 比划开始时加载数据到内存（带锁保护）
  - `_get_data()` / `_save_data()`: 读写操作优先使用缓存
  - `_end_data_cache_async()`: 比划结束时统一保存（try/finally确保安全，带锁保护）
  - 其他命令不受影响（缓存默认None，fallback到直接读写）

- **并发安全**
  - 使用 `asyncio.Lock` 保护缓存操作，防止并发比划导致数据冲突
  - 并发场景下会串行化执行（确保数据一致性）
  - 单用户场景性能提升明显

### Bug修复
- 🐛 修复 `_show_menu` 中多余的缓存调用
- 🐛 修复 `_compare` 中两处绕过缓存的直接读取
- 🐛 添加并发锁防止多用户同时比划时的数据竞争

---

## [v4.18.16] - 2026-01-31

### Bug修复
- **修复打胶波动逻辑错误** 🔴 CRITICAL FIX
  - 🐛 v4.18.15的波动方向是随机的（错误）
  - ✅ 修复为：成功时增加，失败时减少（正确）
  - 📍 位置：main.py:1677-1709

### 正确逻辑
- **打胶成功时**
  - 额外增加当前长度的1-3%
  - 30%概率额外增加1-5硬度

- **打胶失败时**
  - 额外减少当前长度的1-3%
  - 30%概率额外减少1-5硬度

### 代码对比
```python
# ❌ v4.18.15 错误逻辑
if random.random() < 0.5:  # 随机方向，不合理
    extra_length += percentage_change
else:
    extra_length -= percentage_change

# ✅ v4.18.16 正确逻辑
if change > 0:  # 打胶成功
    extra_length += percentage_change  # 额外增加
elif change < 0:  # 打胶失败
    extra_length -= percentage_change  # 额外减少
```

### 示例输出（修复后）
```
🎉 打胶成功！+5cm
📊 额外增长：+2cm (2%)
💎 硬度提升：+3
总计：+7cm，+4硬度
```

---

## [v4.18.15] - 2026-01-31 (已废弃，见v4.18.16修复)

### 新增功能
- **打胶随机波动系统** 🎲 GAMEPLAY（逻辑错误，已在v4.18.16修复）
  - 📊 **长度波动**：每次打胶额外增加/减少当前长度的1-3%
  - 💎 **硬度波动**：30%概率触发硬度变化
  - ⚠️ **问题**：波动方向是随机的，不跟随打胶结果

---

## [v4.18.14] - 2026-01-31

### 健壮性改进
- **中间件异常处理系统** 🛡️ ROBUSTNESS
  - ✅ `subscription_middleware` 添加完整异常捕获
  - ✅ `run_command_middleware` 添加双层异常保护
  - 📢 异常时在群内发送警告消息（不影响命令执行）
  - 🔍 控制台输出完整traceback便于调试
  - 📍 位置：main.py:647-686, 712-793, niuniu_effects.py:249-325

### 异常处理机制
- **订阅中间件层**（niuniu_effects.py:249）
  - 捕获所有异常
  - 返回错误消息字符串
  - 打印完整traceback

- **命令中间件层**（main.py:647）
  - 收集所有中间件的错误消息
  - 双层异常保护（中间件异常 + 调用异常）
  - 返回错误列表

- **调用层**（main.py:712, 732, 743, 752, 788）
  - 检查返回的错误列表
  - 通过 `yield event.plain_result(error)` 在群内发送警告
  - 继续执行命令（不阻断）

### 示例输出
```
⚠️ 订阅中间件异常: 'NoneType' object has no attribute 'get'
[继续执行命令...]
```

---

## [v4.18.13] - 2026-01-31

### 架构改进
- **实现命令中间件系统** 🏗️ ARCHITECTURE
  - ✨ 新增 `run_command_middleware()` 统一入口
  - 📦 注册 `subscription_middleware` 订阅中间件
  - 🔄 所有牛牛命令执行前自动清理过期订阅、重置每日计数
  - 🎯 触发点：handler_map所有命令 + 牛牛菜单 + 开冲 + 停止开冲 + 飞飞机
  - 🚀 易于扩展：未来可添加 daily_reset_middleware、event_middleware 等
  - 📝 位置：main.py:614-632, 660-664, 676-684, 721-723, niuniu_effects.py:249-309

### 重构说明
- **从分散检查到集中管理**
  - ❌ 旧方式：订阅检查分散在各个功能中，容易遗漏
  - ✅ 新方式：统一middleware入口，所有命令都会触发
  - 💡 解决了订阅过期不及时清理、每日计数重置不一致的问题
  - 🔧 为未来的全局功能（签到、任务、事件）打好基础

---

## [v4.18.12] - 2026-01-31

### Bug修复
- **修复订阅系统严重runtime error** 🔴 CRITICAL
  - 🐛 修复吃瓜群众会crash的问题（AttributeError: NiuniuShop has no method get_user_data）
  - 🐛 修复：set_shop传入主插件而非shop对象
  - 🐛 删除冗余的import random
  - 🐛 优化时光倒流VIP触发点（只在比划输时触发，不在打胶时触发）
  - 📍 位置：main.py:50, niuniu_effects.py:622, 648

---

## [v4.18.11] - 2026-01-31

### 新增功能
- **吃瓜群众订阅** (10万/天)
  - 🍉 别人打胶成功时，你获得50%增长
  - 📊 别人增长+8cm → 你吃瓜+4cm
  - ⚡ 每天最多吃瓜20次
  - 💬 触发信息追加到原消息中
  - 🎭 示例：
    ```
    🎉 打胶成功！+8cm +2硬度
    🍉 张三 吃到了你的瓜！(+4cm +1硬度)
    ```

- **时光倒流VIP订阅** (100万/天)
  - ⏰ 受到损失时30%概率时光倒流
  - 🔄 可挽回：长度损失、硬度损失、金币损失
  - ✨ 触发时全部损失无效化
  - 💫 适用场景：打胶失败、比划输了、被攻击道具
  - 🎭 示例：
    ```
    💔 比划失败！-5cm -2硬度
    ⏰ 时光倒流VIP触发！
    ⏪ 时光倒流！损失被抹消了！
    🔄 挽回: 长度-5cm | 硬度-2
    ✨ 命运的齿轮逆转了...
    ```

### 技术改进
- 订阅系统新增触发次数限制机制
- 订阅效果追加到原消息（不刷屏）
- 订阅数据增加每日触发计数

---

## [v4.18.10] - 2026-01-31

### 文案优化
- **未注册文案更搞怪**
  - 📝 "请先注册牛牛" → "你大概是没有牛牛的，请先注册牛牛"
  - 📝 "目标用户未注册" → "该用户大概是没有牛牛的"
  - 🎭 更符合插件的搞怪风格
  - 📍 影响文件：main.py, niuniu_games.py, niuniu_effects.py, niuniu_game_texts.yml

---

## [v4.18.9] - 2026-01-31

### Bug修复
- **修复负数金币订阅折扣漏洞**
  - 🐛 修复用户负数金币购买订阅会获得折扣的问题
  - 🐛 示例：-10万金币购买战斗大师会比0金币便宜7000
  - ✅ 现在负数金币按0处理，不会获得折扣
  - 📍 位置：niuniu_effects.py:51

---

## [v4.18.8] - 2026-01-31

### Bug修复
- **修复税率显示错误**
  - 🐛 修复批量购买时税率显示为首位数字而非位数
  - 🐛 示例：价格1000显示"1%税率" → 修复后显示"4%税率"
  - 📍 位置：niuniu_shop.py:930

### 文档更新
- **更新README价格信息**
  - 📝 夺牛魔蝌蚪罐头：600 → 888
  - 📝 绝对值！倍率：×0.1 → ×0.5

---

## [v4.18.7] - 2026-01-31

### 新增功能
- **订阅服务动态定价系统**：订阅价格现在基于用户财富
  - 💸 定价公式：**基础价 + 用户金币 × (基础价位数)%**
  - 📊 示例：
    - 战斗大师 1000000（7位数）→ 100万 + 金币×7%/天
    - 保险订阅 100000（5位数）→ 10万 + 金币×5%/天
    - 寄生免疫 500000（6位数）→ 50万 + 金币×6%/天
  - 🎯 富人订阅成本更高，穷人也有机会享受服务
  - 💡 批量购买天数时金币递减计算（类似消费税）
  - 📝 订阅商店显示基础价和税率
  - ✅ 示例：拥有100万金币购买战斗大师1天
    - 总价 = 1000000 + 1000000×7% = 1,070,000金币

---

## [v4.18.6] - 2026-01-31

### Bug修复
- **修复寄生牛牛抽取计算错误** 🔴 CRITICAL
  - 🐛 修复寄生抽取使用宿主总长度而非增长量计算（导致宿主增长反而变短）
  - ✅ 现在寄生牛牛抽取宿主**增长量的25%**，而非总长度的25%
  - 📊 修复示例：
    - 旧bug：宿主100cm涨3cm，寄生抽取100×0.25=25cm → 宿主净-22cm ❌
    - 修复后：宿主100cm涨3cm，寄生抽取3×0.25=0.75cm → 宿主净+2.25cm ✅
  - ⚙️ 硬度抽取仍从宿主总硬度计算（因为大部分增长事件不涉及硬度）

---

## [v4.18.5] - 2026-01-31

### Bug修复
- **修复消费税系统严重bug** 🔴 CRITICAL
  - 🐛 修复金币不足检查未考虑消费税（会导致金币变成负数）
  - 🐛 修复批量购买税额计算错误（应该按金币递减计算，而不是简单乘以次数）
  - 🐛 修复批量购买次数计算错误（未考虑消费税导致购买到一半金币不足）
  - ✅ 新增辅助函数：
    - `_calculate_max_purchases_with_tax()`: 循环模拟计算最多可购买次数
    - `_calculate_batch_purchase_taxes()`: 正确计算批量购买总税额
  - ✅ 所有购买分支已修复：
    - 被动道具批量购买
    - 主动道具简单批量购买
    - 牛牛盾牌批量购买
    - 循环触发道具批量购买
    - 单次购买金币检查
  - 📊 修复示例：
    - 旧bug：用户10000金币买3次1000道具，税=(10000×4%)×3=1200
    - 修复后：第1次400税，第2次344税，第3次290税，总税1034（正确！）

### 数值调整
- **夺牛魔蝌蚪罐头价格调整**
  - 💰 价格从 600 提升到 888 金币
  - ⚖️ 提高强力被动道具的使用成本

---

## [v4.18.4] - 2026-01-31

### Bug修复
- **牛牛寄生触发条件修复**：修复对大佬几乎无效的问题
  - ❌ 旧逻辑：宿主增长 > 宿主长度5%（大佬100cm需增长5cm才触发）
  - ✅ 新逻辑：宿主增长 >= 寄生者长度5%（寄生者20cm，宿主增长1cm就触发）
  - 🎯 现在对大佬也有效了！大佬打胶通常增长几cm，完全可以触发
  - 📊 示例：
    - 寄生者长度20cm → 阈值1cm（20×5%）
    - 宿主打胶+3cm → 触发抽取！✅
    - 之前：宿主100cm → 阈值5cm → 不触发 ❌

### 数值调整
- **牛牛黑洞价格调整**
  - 💰 价格从 300 提升到 1000 金币
  - ⚖️ 提高大范围攻击道具的使用成本

---

## [v4.18.3] - 2026-01-31

### 新增功能
- **商城消费税系统**：所有道具购买时需额外缴纳消费税，有效控制富人金钱积累
  - 💸 税率规则：**几位数就是%几**
    - 100金币（3位数）→ 3%税率
    - 1000金币（4位数）→ 4%税率
    - 10000金币（5位数）→ 5%税率
  - 📊 税基 = 用户当前总金币
  - 💰 总花费 = 道具价格 + 用户金币 × 税率
  - 🎯 富人买道具付出更多代价
  - 示例：
    - 道具价格 1000（4位数），用户有 50000 金币
    - 消费税 = 50000 × 4% = 2000 金币
    - 总花费 = 1000 + 2000 = 3000 金币
  - ✨ 适用于所有道具（包括动态定价道具）
  - ✨ 支持批量购买（税额按次数叠加）

### 数值调整
- **牛牛均富/负卡定价优化**
  - 💰 新公式：基础价 + Σ|长度差| × 系数 + **使用者金币 × 50%**
  - 🎯 富豪使用成本更高，防止滥用均富
  - 💡 真正的穷人更容易使用均富卡翻身
  - 示例：拥有10000金币的富豪购买均富卡，需额外支付5000金币（50%财富税）

- **牛牛黑洞概率重构**
  - 📊 新概率分布（旧→新）：
    - ✅ 归你：40% → **50%**（成功率提升）
    - 💨 喷射路人：30%一半 → **10%全部**（不再分给自己）
    - 💀 反噬自己：20% → **10%**（降低风险）
    - 🔄 **反馈给目标：0% → 10%**（新增！能量返回受害者）
    - 🌌 **消散于宇宙：0% → 20%**（新增！长度永久消失）
  - 🎭 新增反馈和消散文案，更多搞笑场景
  - ⚖️ 总体风险降低，但增加了"白忙一场"的可能性

- **绝对值！价格调整**
  - 💰 动态价格从 `|长度| × 0.1` 提升到 `|长度| × 0.5`
  - ⚖️ 提高翻身成本，平衡负数牛牛经济

- **牛牛大自爆价格调整**
  - 💰 价格从 250 提升到 1000 金币
  - ⚖️ 增加同归于尽的使用成本

---

## [v4.18.2] - 2026-01-31

### 道具调整
- **小蓝片副作用**：购买时额外消耗10%长度
  - 💊 每购买1次小蓝片，扣除当前长度的10%
  - 💊 批量购买会叠加消耗（买3次 = 30%长度）
  - ⚠️ 增加使用成本，平衡强力效果
  - 📋 道具描述已更新

### Bug修复
- **修复严重运行时错误**：
  - 🐛 添加缺失的 `modify_coins` 方法（niuniu_shop.py:211-222）
    - 此bug会导致金币消失系统（v4.16.0）、金币下注（v4.15.0）、抢劫系统（v4.18.0）全部崩溃
    - 影响范围：12处调用全部失效
    - 修复方式：实现 `modify_coins(group_id, user_id, delta)` 方法用于增减金币
  - 🐛 修复抢劫打斗负数长度处理错误（main.py:2764-2768）
    - 原bug：负数长度打斗后变得*更长*（-100cm → -90cm）
    - 修复后：负数长度打斗后正确变得*更短*（-100cm → -110cm）
    - 简化逻辑：无论正负长度，损失都是减法操作

---

## [v4.18.1] - 2026-01-31

### 新增功能
- **保险订阅服务** (10万金币/天)
  - 📋 无限次理赔，每次赔付10,000金币
  - ⚠️ 损失>=50cm或硬度>=10时触发
  - 🔄 完全替换道具版"上保险"（已从商城移除）
  - ✅ 兼容旧道具：已购买的"上保险"次数仍然有效

- **寄生免疫订阅** (50万金币/天)
  - 🚫 完全免疫寄生牛牛
  - 💎 任何人尝试寄生都会失败并退款

- **抢劫打斗系统**：抢劫成功后可能触发激烈打斗！
  - **触发概率**：50%概率打斗，50%概率投降
  - **打斗效果**：双方都会损失长度和硬度
  - **损失档位**（递减概率）：
    - 5-15%损失：40%概率（小打小闹）
    - 20-35%损失：30%概率（激烈交锋）
    - 40-55%损失：20%概率（惨烈厮杀）
    - 60-75%损失：10%概率（你死我活）
  - **投降场景**：目标瑟瑟发抖直接投降，不损失长度/硬度
  - 示例：
    ```
    抢劫成功 → 触发打斗（50%）
    ⚔️ 双方激烈打斗！拳拳到肉！
    💔 小A：-15cm长度, -3硬度
    💔 小B：-12cm长度, -2硬度
    📊 损失比例：30.5%
    ```

### 删除功能
- **移除"上保险"道具**：改为订阅制
  - ❌ 从商城移除道具版"上保险"（1000金币/10次）
  - ✅ 现有的保险次数仍然有效（200金币/次）
  - 💎 订阅版无限次理赔，赔付金额更高（10,000金币/次）

- **移除开团功能**：根据用户反馈，删除了不够有趣的开团玩法
  - 删除了 `开团` 命令
  - 删除了相关冷却时间常量 `KAITAN_COOLDOWN`
  - 清理了菜单、README 中的开团引用
  - 简化了游戏玩法，专注于更有趣的抢劫、比划等互动

### Bug修复
- **冷却时间优化**：修复冷却时间更新时机
  - 之前：目标没金币也会消耗冷却
  - 现在：只有真正抢劫后才消耗冷却
- **事件处理健壮性**：添加未知事件类型的降级处理

---

## [v4.18.0] - 2026-01-31

### 新增功能
- **牛牛抢劫系统**：概率性抢劫他人金币，充满风险与刺激！
  - 使用方式：`牛牛抢劫 @目标`
  - 冷却时间：15分钟
  - **胜负判定**：完全复用比划逻辑（长度、硬度、连胜/连败加成）
  - **抢劫金额档位**（成功后，递减概率）：
    - 5-15%：40%概率（小偷小摸）
    - 20-30%：30%概率（中等收获）
    - 35-50%：20%概率（大丰收）
    - 55-70%：10%概率（洗劫一空）

  - **抢劫后事件**（15-20种花样，混合风格）：
    - **完美逃脱类**（30%）：成功带走所有金币
      - 完美逃脱、地下通道、伪装大师
    - **归还部分类**（25%）：被追上，归还50-80%给原主人
      - 牛牛警察追捕、受害者追击、良心发现
    - **损失大部分类**（20%）：金币消失70-90%
      - 掉进下水道、遇到劫匪、警察没收
    - **捐赠/消失类**（15%）：金币全部消失
      - 捐给慈善、化身罗宾汉、因果报应
    - **意外收获类**（5%）：额外获得20-100%奖励
      - 发现钱包、投资成功
    - **搞笑意外类**（5%）：被猫抢走、妖风吹跑、黑洞吸走

  - 示例：抢劫成功拿到1000金币（30%），触发"被追上"事件，归还60%（600金币），最终得到400金币

---

## [v4.17.1] - 2026-01-31

### Bug修复
- 🔴 **订阅功能异常处理**：添加 try-except 保护，防止异常导致金币丢失
  - 如果订阅过程抛出异常，会自动退款
  - 确保金币和订阅数据的一致性

- **排行榜负数金币显示**：修复 format_coins 函数，正确显示负数金币
  - 之前：-1000金币显示为 `1.0k`
  - 现在：-1000金币显示为 `-1.0k`

- **梭哈最小金额优化**：提高最小金额要求，改善用户体验
  - 之前：最低1金币（扣除3%手续费后仅0.97金币）
  - 现在：最低2金币（确保购买有实际意义）

---

## [v4.17.0] - 2026-01-31

### 新增功能
- **每日订阅服务系统**：高端订阅服务，为富豪量身打造
  - 新增统一效果中间件系统，支持订阅、道具、状态、永久buff等多种效果类型
  - 订阅到期自动失效，金币不足不自动续费
  - 单次订阅最多365天
  - 取消订阅不退款
  - 相关命令：
    - `牛牛订阅商店` / `牛牛订阅商城` - 查看所有订阅服务
    - `牛牛订阅 <编号> [天数]` - 订阅服务（默认1天）
    - `牛牛取消订阅 <编号>` - 取消订阅
    - `牛牛背包` - 查看当前订阅和道具

- **战斗大师订阅** (100万/天)
  - 打胶冷却减少75%（从10分钟减至2.5分钟）
  - 打胶成功率+10%
  - 比划胜率+5%
  - 失败仍扣长度（保持平衡）

- **命令别名**：更多命令可用
  - `牛牛商城` 可以叫 `牛牛道具商城` / `牛牛道具商店`
  - `牛牛订阅商店` 可以叫 `牛牛订阅商城`

### 系统优化
- 重构效果系统，将道具效果和订阅效果统一管理
- 订阅效果无缝集成到现有游戏逻辑中
- 支持未来扩展更多订阅服务和永久buff
- **背包整合订阅信息**：订阅服务现在直接显示在牛牛背包中，无需单独命令查看

### Bug修复
- 🔴 修复严重漏洞：订阅时先扣金币再保存订阅，避免金币不足时免费订阅
- 🔴 修复背包显示订阅时的属性错误（self.plugin → self.main）
- 添加未注册用户订阅检查，避免浪费金币
- 限制单次订阅最大天数为365天，避免整数溢出

---

## [v4.16.0] - 2026-01-31

### 新增功能
- **股市梭哈功能**：牛牛股市购买支持"梭哈"命令
  - 使用方式：`牛牛股市 购买 梭哈`
  - 自动投入当前财富的95%购买股票
  - 适合激进型投资牛牛，一键满仓！
  - 示例：拥有1000金币的牛牛梭哈，将投入950金币购买妖牛股

- **金币消失系统**：牛牛大自爆、牛牛黑洞、月牙天冲新增金币消失机制
  - 所有被影响的人（包括发起人）都有概率失去金币
  - 金币直接消失，不转移给任何人
  - **触发概率**：75%概率触发金币损失，25%概率不触发
  - **损失档位**（递减概率）：
    - 5-10%损失：40%概率
    - 15-25%损失：30%概率
    - 30-40%损失：20%概率
    - 45-50%损失：10%概率
  - **牛牛大自爆**：💥 炸飞金币
  - **牛牛黑洞**：🌀 吸走金币（包括backfire情况）
  - **月牛天冲**：🌙 震碎金币（目标和发起人都可能失去）
  - 示例：某人有1000金币，被黑洞击中，75%概率触发，如触发则40%概率损失50-100金币（5-10%）

---

## [v4.15.2] - 2026-01-31

### 显示优化
- **排行榜两行显示**: 优化排行榜显示格式，避免单行过长
  - 第一行：排名、昵称、长度、硬度
  - 第二行：金币、寄生标记（如果有）
  - 示例：
    ```
    1. 小牛 ➜ 25.5cm 💪5
       💰 1.2k
    2. 大牛 ➜ 30.2cm 💪8
       💰 500 🪱寄生牛牛
    ```

---

## [v4.15.1] - 2026-01-31

### 显示优化
- **排行榜金币显示**: 排行榜新增金币显示，使用缩写格式
  - 小于1000：显示具体数字（如 `500`）
  - 1000-999999：显示k格式（如 `1.5k`）
  - 1百万-9亿9千9百万：显示m格式（如 `2.3m`）
  - 10亿及以上：显示b格式（如 `1.2b`）
  - 格式：`排名. 昵称 ➜ 长度 💪硬度 💰金币`

---

## [v4.15.0] - 2026-01-31

### 新增功能
- **比划比划金币下注系统**: 胜者从败者获得金币（扣除税金）
  - 使用方式：`牛牛比划 @目标 [金币数]`
  - 获胜方：从失败方获得下注金额（扣税后）
  - 失败方：失去下注金额（含税）
  - 税率与股市税率完全一致（阶梯累进税）
  - 复用股市税率计算函数，确保经济系统一致性
  - 金币不足时按实际金币结算
  - 显示详细税收信息（税额、税率、税率档位明细）
  - 示例：下注1000金币，群平均500金币（2倍），税率30%，获胜方得700金币

---

## [v4.14.20] - 2026-01-31

### Bug修复
- **循环触发道具批量购买bug修复**: 修复v4.14.19引入的多个bug
  - 添加效果不存在的错误检查，防止购买无效道具
  - 修复硬度上限检查bug：改为循环中动态检查，达到上限时提前终止
  - 添加股市钩子调用：批量购买后正确触发股市波动
  - 修复金币扣除逻辑：只扣除实际成功购买的次数
  - 改进错误提示：区分硬度上限和金币不足的情况
  - 示例：巴黎牛家批量购买，硬度达到上限时自动停止，不会多扣金币

---

## [v4.14.19] - 2026-01-31

### 新增功能
- **6个道具支持批量购买**: 修复了被错误标记为复杂道具的简单道具
  - **增加次数类**（可批量购买）：
    - 祸水东引：`牛牛购买 13 N次` - 累积转嫁次数
    - 上保险：`牛牛购买 14 N次` - 累积理赔次数（每次+10）
    - 牛牛反弹：`牛牛购买 21 N次` - 累积反弹次数
  - **简单效果类**（可批量购买）：
    - 巴黎牛家：`牛牛购买 1 N次` - 累积硬度+10，每次随机-1~10%长度
    - 赌徒骰子：`牛牛购买 6 N次` - 每次独立掷骰子，累积效果
    - 穷牛一生：`牛牛购买 10 N次` - 每次独立赌博，累积效果
  - 批量购买显示累计效果和各项次数统计
  - 示例：`牛牛购买 14 5次` = 购买5次上保险，获得50次理赔

---

## [v4.14.18] - 2026-01-31

### 数值调整
- **新增95%极限税率档位**: 对极端暴利收益几乎全额充公
  - 新增20倍以上收益档位：95%税率
  - 原10倍以上90%税率改为：10-20倍90%税率
  - 完整税率阶梯：
    - 0-0.3倍平均：免税
    - 0.3-0.5倍：5%
    - 0.5-1倍：10%
    - 1-1.5倍：20%
    - 1.5-2倍：30%
    - 2-3倍：45%
    - 3-5倍：60%
    - 5-10倍：75%
    - 10-20倍：90%
    - **20倍以上：95%** ← 新增
  - 示例：群平均100万，赚2000万（20倍）→ 有效税率约93%，到手仅140万
  - 新增专属95%税率文案，强调极端暴利的惩罚性

---

## [v4.14.17] - 2026-01-31

### 新增功能
- **牛牛盾牌支持批量购买**: 现在可以使用 `牛牛购买 9 N次` 批量购买盾牌
  - 每次购买扣除当前50%长度和硬度（递减式代价）
  - 每次购买获得3次护盾，批量购买累积护盾次数
  - 示例：购买3次盾牌
    - 第1次：扣50%（100cm→50cm），+3护盾
    - 第2次：扣50%（50cm→25cm），+3护盾
    - 第3次：扣50%（25cm→12.5cm），+3护盾
    - 总计：长度从100cm降至12.5cm，获得9次护盾
  - 批量购买显示累计代价和总护盾数

---

## [v4.14.16] - 2026-01-31

### 数值调整
- **倒手费机制优化**: 改为只针对获利部分收费
  - 旧机制：持仓不足1分钟卖出，收取卖出总额的50%
  - **新机制：持仓不足1分钟卖出，仅收取获利部分的75%**
  - 亏损交易不收取倒手费（更人性化）
  - 示例1：买入10万，卖出12万，获利2万 → 倒手费1.5万（2万×75%）
  - 示例2：买入10万，卖出9万，亏损1万 → 倒手费0（亏损不收费）
  - 更精准打击套利行为，同时保护亏损交易者

---

## [v4.14.15] - 2026-01-31

### 数值调整
- **倒手费时间缩短**: 持仓时间要求从3分钟缩短为1分钟
  - 更严格打击快速倒手套利行为
  - 持仓不足1分钟卖出仍收取50%倒手费

- **收益税阶梯加强**: 大幅提高高收益税率，防止富者愈富
  - 0-0.3倍平均：免税（保护小额收益）
  - 0.3-0.5倍：5%
  - 0.5-1倍：10%
  - 1-1.5倍：20%
  - **1.5-2倍：30%**（翻倍收益已经30%税，不再是10%）
  - 2-3倍：45%
  - 3-5倍：60%
  - 5-10倍：75%
  - **10倍以上：90%**（超高暴利重税）
  - 示例：群平均100万，赚200万收益，有效税率约35%（而非之前的10%）

---

## [v4.14.14] - 2026-01-31

### 数值调整
- **劫富济贫护盾平衡性修复**: 修复护盾抵挡时凭空产生长度的bug
  - 首富有护盾时，幸运儿们仅获得原收益的10%（补偿机制）
  - 原先：护盾抵挡时仍分配100%收益，导致凭空产生长度
  - 现在：护盾抵挡时仅分配10%补偿，维持游戏平衡
  - 示例：首富100cm有护盾，原本凭空产生50cm分给幸运儿 → 现在仅产生5cm补偿
  - 其他抢劫类道具（月牙天冲、牛牛黑洞、牛牛大自爆）逻辑正确，无需修改

---

## [v4.14.13] - 2026-01-31

### 新增功能
- **股票持仓时间限制**: 防止快速倒手套利
  - 买入股票后需持有至少1分钟才能卖出
  - 持仓不足1分钟卖出将收取50%倒手费（在基础手续费之外）
  - 卖出时会显示持仓时间和倒手费警告
  - 有效遏制高频交易套利行为

---

## [v4.14.12] - 2026-01-31

### 数值调整
- **股票交易手续费**: 买入和卖出股票都收取3%手续费
  - 买入：从支付金额中扣除3%，实际购买金额为97%
  - 卖出：从卖出所得中扣除3%手续费（在收益税之后）
  - 手续费减少频繁交易套利，增加交易成本

### 文档修正
- **删除救市金额上限说明**: 救市功能是管理员操纵股市的工具，无需金额限制

---

## [v4.14.11] - 2026-01-31

### Bug修复
- **修复被动道具购买崩溃**: 修复购买被动道具（如小蓝片）时出现UnboundLocalError的问题
  - 股市钩子现在仅对主动道具生效，避免访问未定义的ctx变量
  - 被动道具购买恢复正常
- **修复日志错误**: 修复logger属性不存在导致的二次错误
  - 改用print输出错误日志，确保错误信息能正常记录

---

## [v4.14.10] - 2026-01-27

### 功能优化
- **道具购买股市均值回归**: 购买道具时股市涨跌改为均值回归模式
  - 股价高于基准价(100)时，购买道具倾向让股价下跌回归
  - 股价低于基准价(100)时，购买道具倾向让股价上涨回归
  - 偏离越大，回归力度越大（最高85%概率回归）
  - 道具购买变成"市场稳定器"，不再因道具效果正负单边波动
  - 打胶、比划等游戏行为仍使用原逻辑

---

## [v4.14.9] - 2026-01-27

### 功能优化
- **合并牛牛红包和牛牛补贴**: 统一为「牛牛红包」命令
  - `牛牛红包 @用户 <长度> <硬度> <金币>` - 给指定牛友
  - `牛牛红包 所有人 <长度> <硬度> <金币>` - 给全体牛友
  - 支持负数（扣除属性）
  - 删除原「牛牛补贴」命令

---

## [v4.14.8] - 2026-01-26

### 新增功能
- **牛牛救市支持砸盘**: 管理员可以用负数金额砸盘
  - `牛牛救市 10000` - 救市拉升股价
  - `牛牛救市 -10000` - 砸盘打压股价
  - 包含全新砸盘文案（国家队反手做空等）

---

## [v4.14.7] - 2026-01-26

### 显示优化
- **更新牛牛菜单**: 补全所有管理员命令
  - 新增: 牛牛救市、牛牛股市 重置、重置所有牛牛 <类型>

---

## [v4.14.6] - 2026-01-26

### 新增功能
- **重置所有牛牛 分类重置** (管理员命令): 支持按类型重置数据
  - `重置所有牛牛 金币` - 所有牛友金币归零
  - `重置所有牛牛 长度` - 所有牛牛长度随机重置（3-10cm）
  - `重置所有牛牛 硬度` - 所有牛牛硬度归一
  - `重置所有牛牛 股市` - 清空所有牛友股票持仓（保留股价）
  - `重置所有牛牛 全部` - 重置以上所有数据

---

## [v4.14.5] - 2026-01-26

### 数值调整
- **股市事件概率化**: 事件的涨跌不再是确定的，而是概率性的
  - 之前：道具使长度增加 → 股价100%涨，道具使长度减少 → 股价100%跌
  - 现在：变化量影响涨跌概率，但不是100%确定
  - 正变化（长度增加等）：50%-85% 概率涨
  - 负变化（长度减少等）：50%-85% 概率跌
  - 变化量越大，概率偏向越明显（最高85%，妖股就要妖）
  - 混沌/全局事件保持 50/50 完全随机
  - 这样股市既有趋势性，又保留了反转的可能

---

## [v4.14.4] - 2026-01-24

### 新增功能
- **牛牛股市 重置** (管理员命令): 重置股市所有数据
  - 股价恢复到 100
  - 清空所有人的持仓
  - 清空所有人的投资统计（盈亏、交易次数等）
  - 清空股市事件记录
  - 包含趣味重置文案

---

## [v4.14.3] - 2026-01-24

### 数值调整
- **大幅降低开团股市波动**: 修复开团导致股价暴跌 80% 的问题
  - chaos 波动范围从 5%-20% 降至 2%-8%
  - 移除 chaos/global 事件的 1.5 倍幅度加成
  - global 波动范围从 10%-30% 降至 5%-15%
  - 现在开团最大波动约 8%-24%（取决于长度变化）

---

## [v4.14.2] - 2026-01-24

### 新增功能
- **牛牛救市** (管理员命令): 系统资金购入股票后销毁
  - 格式: `牛牛救市 <金额>`
  - 只推高股价，不计入任何人持仓
  - 救市影响幅度基于金额，无上限
  - 包含「中央牛行」「牛牛国家队」等趣味文案

---

## [v4.14.1] - 2026-01-24

### 新增功能
- **买卖股票影响股价**: 买入推高股价，卖出压低股价
  - 影响幅度 0.1%-2%，根据交易金额计算
  - 先变价再成交：买入按涨后价成交，卖出按跌后价成交（防止套利）
  - 形成自然的市场调节：股价低时买入多 → 价格回升；股价高时卖出多 → 价格回落

---

## [v4.14.0] - 2026-01-24

### 道具重做
- **赌徒硬币 → 赌徒骰子**: 完全重做机制
  - 原机制: 50%翻倍/48%减半/1%×4/1%×-2（比例变化太大）
  - 新机制: 掷骰子1-6点，按当前长度比例增减
    - 🎲 1点: -30%
    - 🎲 2点: -20%
    - 🎲 3点: -10%
    - 🎲 4点: +10%
    - 🎲 5点: +20%
    - 🎲 6点: +30%
  - 波动更加温和可控，不会因为一次操作导致数值失衡

---

## [v4.13.4] - 2026-01-24

### 数值调整
- **开团股市影响改为平均值**: 开团影响股市时，使用参与者长度变化的平均值而非总和，避免波动过大

---

## [v2.3.1] - 2026-01-23

### 新增功能
- **开团影响股市**: 开团结束后触发混沌事件，股市波动 5%-20%

---

## [v2.3.0] - 2026-01-23

### 新增功能
- **股票收益阶梯税**: 卖出股票时需缴纳累进收益税
  - 0~2倍平均：10%
  - 2~3倍：20%
  - 3~5倍：30%
  - 5~10倍：50%
  - 10倍以上：75%
  - 显示详细税收计算过程和趣味文案
  - 税务局主题文案：高税率时有特殊吐槽

---

## [v2.2.2] - 2026-01-23

### Bug修复
- 修复金币显示精度问题（如 xx.99998）
  - 所有金币变动时自动 `round()` 取整
  - 股票卖出时金币计算改为 `round(shares * price, 2)`

### 数据存储优化
- 股市数据文件路径改为 `data/niuniu_stock.json`
  - 与其他数据存在同一目录，重装插件不会丢失

---

## [v2.2.1] - 2026-01-23

### 数值调整
- **牛牛均富/负卡动态定价**: 从固定1888金币改为动态定价
  - 公式: 价格 = 1888 + Σ|长度 - 平均长度| × 0.0005
  - 群内长度分布越分散，价格越高；分布越集中，价格越低
  - 最低价格 1888 金币，无上限
  - 商城显示当前群的实际价格

---

## [v2.2.0] - 2026-01-23

### 新增道具
- **牛牛反弹** (125金币): 受到>=50cm伤害时反弹给攻击者
  - 反弹后可触发攻击者的护盾、祸水东引、保险
  - 支持乒乓连弹！双方都有反弹时可形成最多5连弹
  - 连弹时有特殊趣味文案
  - 无法反弹夺牛魔的伤害

### 数值调整
- **祸水东引价格**: 250 → 125 金币

### 机制优化
- **统一伤害处理**: 新增 `_apply_damage_with_effects` 方法统一处理伤害效果链
- **防御优先级明确**: 反弹 > 祸水东引 > 护盾 > 保险

---

## [v2.1.9] - 2026-01-23

### 文档
- **README 重写**: 全新文档结构，更清晰的指令和道具说明
- **致谢原作者**: 感谢 [zgojin](https://github.com/zgojin/astrbot_plugin_niuniu) 的原始创意
- **添加 MIT License**

---

## [v2.1.8] - 2026-01-23

### 显示优化
- **商城金币不足提示统一优化**: 所有购买场景都显示需要金币、当前金币、还差金币

---

## [v2.1.7] - 2026-01-23

### 显示优化
- **绝对值！金币不足提示优化**: 显示需要金币、当前金币、还差金币

---

## [v2.1.6] - 2026-01-23

### 显示优化
- **商城动态定价显示**: 绝对值！道具在商城中显示用户的实际价格
  - 负数牛牛：显示计算后的价格（如 "100 💰 (你的价格)"）
  - 正数牛牛：显示 "仅限负数牛牛"

---

## [v2.1.5] - 2026-01-23

### 数值调整
- **绝对值！价格降低**: 从 |长度| 金币 改为 |长度| × 0.1 金币

---

## [v2.1.4] - 2026-01-23

### 数值调整
- **比划下注上限**: 500 → 10000 金币

---

## [v2.1.3] - 2026-01-23

### 优化
- **菜单完善**: 比划比划命令说明补充下注功能

---

## [v2.1.2] - 2026-01-23

### 优化
- **帮助命令别名**: 新增 `牛牛帮助` 作为 `牛牛菜单` 的别名

---

## [v2.1.1] - 2026-01-23

### 股市系统优化
- **道具专属股市影响**: 每个道具有自己的股市配置
  - 波动幅度按道具类型区分
  - 专属股市文案，更有代入感
  - 工具类道具（驱牛药、上保险）使用"平淡"文案，波动极小(0.1%-0.5%)
- **stock_hook 接口重构**: 支持自定义波动范围和模板
  - 道具效果和股市影响写在一起，更易维护
  - `templates.plain` 支持工具类道具的平淡反应文案

### 已配置股市影响的道具
| 道具 | 波动范围 | 文案风格 |
|------|----------|----------|
| 混沌风暴 | 5%-20% | 混沌主题 |
| 牛牛均富/负卡 | 10%-30% | 均富主题 |
| 牛牛黑洞 | 8%-25% | 黑洞主题 |
| 牛牛大自爆 | 8%-25% | 爆炸主题 |
| 劫富济贫 | 3%-10% | 劫富主题 |
| 赌徒硬币 | 2%-8% | 赌博主题 |
| 月牙天冲 | 3%-10% | 剑气主题 |
| 牛牛盾牌 | 2%-6% | 防御主题 |
| 巴黎牛家 | 2%-6% | 牛家主题 |
| 牛牛寄生 | 2%-6% | 寄生主题 |
| 驱牛药 | 0.1%-0.5% | 平淡反应 |
| 上保险 | 0.1%-0.5% | 平淡反应 |

---

## [v2.1.0] - 2026-01-23

### 新增功能
- **牛牛股市**: 全新妖牛股交易系统
  - 用金币购买/出售妖牛股
  - 所有游戏事件（打胶/比划/道具/开冲等）都会影响股价
  - 股价波动剧烈，真正的妖股体验
  - 事件类型不同，波动幅度不同：
    - 打胶：0.5%-2% 微波动
    - 比划：1%-5% 小波动
    - 道具：2%-8% 中波动
    - 混沌风暴：5%-20% 大波动
    - 全局事件：10%-30% 剧烈波动
  - 股市行情显示最近事件动态
  - 命令：`牛牛股市`、`牛牛股市 购买 <金额>`、`牛牛股市 出售 [数量/全部]`、`牛牛股市 持仓`
  - 负数牛牛禁止进入股市

---

## [v2.0.9] - 2026-01-23

### 新增道具
- **牛牛均富/负卡** (1888金币): 发动！全群所有牛牛长度和硬度取平均值！
  - 效果：计算群内所有牛牛的平均长度和硬度，然后把所有人都设为平均值
  - 大佬血亏，负数狂喜，中间人不亏不赚
  - 最少需要3人才能发动
  - 显示变化最大的前5名亏损者和前5名受益者

---

## [v2.0.8] - 2026-01-23

### 显示优化
- **长度单位自动转换**: 当长度绝对值超过阈值时自动转换单位显示
  - ≥100cm 显示为 m（如 1.50m）
  - ≥1km (100000cm) 显示为 km（如 2.30km）
  - 负数显示带 (凹) 标记（如 -5.00m (凹)）
- **核心道具显示优化**: 赌徒硬币、月牙天冲等道具效果文案支持自动单位转换

---

## [v2.0.7] - 2026-01-23

### 机制完善
- **夺牛魔蝌蚪罐头负数支持**: 完善对负数牛牛的支持
  - **夺取(50%)**: 可夺取负数牛牛，吸收目标债务（自己变短），目标归零重获新生
  - **大自爆(20%)**: 负数用户可自爆，因祸得福归零，但不对别人造成伤害
  - **自爆归零(10%)**: 负数用户归零是因祸得福，专属趣味文案

### 代码重构
- **保险理赔逻辑统一**: 将比划和道具购买的保险理赔逻辑统一为 `check_insurance_claim` 方法
  - 支持直接修改 `group_data`（批量操作）或独立保存（比划场景）
  - 减少重复代码，便于维护

---

## [v2.0.6] - 2026-01-23

### Bug修复
- **上保险理赔不生效**: 修复被动受害者（如被月牙天冲、劫富济贫等攻击）的保险理赔金币被后续数据保存覆盖的问题
- **上保险理赔金币被覆盖**: 修复购买道具时触发自己保险理赔后，理赔金币被购买扣费逻辑覆盖的问题
  - 原因：扣费时使用的是购买前的金币数，不包含理赔金额
  - 修复：正确计算扣费后金币 = 购买前金币 - 道具价格 + 理赔金额

---

## [v2.0.5] - 2026-01-22

### 机制调整
- **牛牛寄生**: 改为指定目标寄生（原为随机）
  - 用法：`牛牛购买 18 @目标`
  - 不能寄生自己
  - 目标必须已注册牛牛

---

## [v2.0.4] - 2026-01-22

### 新增功能
- **牛牛寄生** (150金币): 在指定群友身上种下寄生牛牛
  - 触发条件：宿主增长超过自身绝对值长度的 5% 时
  - 抽取效果：抽取宿主 5% 绝对值长度 + 5% 硬度给受益者
  - 持续存在直到宿主购买驱牛药
  - 单一寄生机制：新寄生覆盖旧寄生（有专属文案）
  - 支持链式反应（A→B→C递归触发）

- **驱牛药** (75金币): 清除自己身上的寄生牛牛
  - 显示被清除的寄生牛牛来源

### 显示优化
- 我的牛牛：显示 `🦠【寄】寄生牛牛来自：{受益者名}`
- 牛牛排行榜：带寄生的用户显示 `【寄】` 标记
- 牛牛背包：显示寄生状态和清除提示

### 触发场景
寄生牛牛在以下场景检查触发：
- 打胶增益
- 比划获胜增益
- 混沌风暴增益
- 商城道具增益

---

## [v2.0.3] - 2026-01-22

### 新增功能
- **牛牛补贴**: 管理员可给指定用户补贴/扣除属性
  - 命令格式：`牛牛补贴 @用户 长度 硬度 金币`
  - 支持负数参数（倒扣）
  - 硬度最低为0，长度和金币可为负数（欠账）

---

## [v2.0.2] - 2026-01-21 道具系统大改版

### 新增道具
- **小蓝片** (200金币): 下次比划硬度视为100
- **牛牛黑洞** (300金币): 吸取5-15人各3-10%长度
  - 40% 全归使用者
  - 30% 一半喷射给路人
  - 20% 反噬自己
  - 10% 吃撑反喷（所有人反而变长）

### 删除道具
- 巴适得板生长素
- 不灭之握
- 阿姆斯特朗旋风喷射炮

### 道具调整
| 道具 | 原效果 | 新效果 |
|------|--------|--------|
| 巴黎牛家 | +3硬度 (50金币) | +10硬度, -1~10%长度 (200金币) |
| 淬火爪刀 | 额外掠夺10%长度 | 额外掠夺10%长度和10%硬度 |
| 夺牛魔蝌蚪罐头 | 50%夺取/20%清空/30%无效 | 50%夺取全部(长度+硬度)/20%混沌风暴/20%大自爆/10%自爆归零 |
| 赌徒硬币 | 50%翻倍/50%减半 | 50%翻倍/48%减半/1%头等奖(x4)/1%霉运(x-2) |
| 劫富济贫 | 抢15%长度 (300金币) | 抢50%长度+20%硬度 (600金币) |
| 牛牛盾牌 | 直接获得护盾 | 购买时扣除当前50%长度和硬度 |

### 数值调整
- 打胶早期增长上限: 5 → 10cm
- 打胶后期增长范围: 3-6 → 4-12cm

### Bug修复
- 修复开团发起者可能不在团内的问题
- 修复批量购买 `牛牛购买 1 2` 只买1个的问题
- 修复混沌连锁显示 `???` 的问题
- 修复护盾无法抵挡全局事件的问题

### 护盾机制完善
- 混沌风暴个人负面事件检查护盾
- 全局事件 (末日审判/反向天赋/团灭彩票) 检查护盾
- `chaos_tax` 不可被护盾抵挡（核心收益机制）

#### 护盾可抵挡的事件
| 类型 | 事件 | 效果 |
|------|------|------|
| 个人负面 | length_down | 长度-1~15cm |
| 个人负面 | hardness_down | 硬度-1~2 |
| 个人负面 | coin_lose | 失去10~50金币 |
| 个人负面 | length_percent_down | 长度-5~20% |
| 个人负面 | halve | 长度减半 |
| 个人负面 | give_to_random | 送给随机人3~10cm |
| 个人负面 | dark_sacrifice | 牺牲20%长度给别人x3 |
| 个人负面 | reverse_sign | 正负翻转（仅正数时） |
| 全局事件 | doomsday | 最短者归零（最短者可防护） |
| 全局事件 | reverse_talent | 最长最短互换（最长者可防护） |
| 全局事件 | lottery_bomb 95% | 全体-50%（每人单独检查） |
