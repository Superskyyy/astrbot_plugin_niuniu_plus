# Changelog

## [v2.1.1] - 2026-01-23

### 股市系统优化
- **道具专属股市影响**: 每个道具有自己的股市配置
  - 波动幅度按道具类型区分
  - 专属股市文案，更有代入感
  - 工具类道具（驱牛药、上保险）使用"平淡"文案，波动极小(0.1%-0.5%)
- **stock_hook 接口重构**: 支持自定义波动范围和模板
  - 道具效果和股市影响写在一起，更易维护
  - `templates.plain` 支持工具类道具的平淡反应文案

### 已配置股市影响的道具
| 道具 | 波动范围 | 文案风格 |
|------|----------|----------|
| 混沌风暴 | 5%-20% | 混沌主题 |
| 牛牛均富/负卡 | 10%-30% | 均富主题 |
| 牛牛黑洞 | 8%-25% | 黑洞主题 |
| 牛牛大自爆 | 8%-25% | 爆炸主题 |
| 劫富济贫 | 3%-10% | 劫富主题 |
| 赌徒硬币 | 2%-8% | 赌博主题 |
| 月牙天冲 | 3%-10% | 剑气主题 |
| 牛牛盾牌 | 2%-6% | 防御主题 |
| 巴黎牛家 | 2%-6% | 牛家主题 |
| 牛牛寄生 | 2%-6% | 寄生主题 |
| 驱牛药 | 0.1%-0.5% | 平淡反应 |
| 上保险 | 0.1%-0.5% | 平淡反应 |

---

## [v2.1.0] - 2026-01-23

### 新增功能
- **牛牛股市**: 全新妖牛股交易系统
  - 用金币购买/出售妖牛股
  - 所有游戏事件（打胶/比划/道具/开冲等）都会影响股价
  - 股价波动剧烈，真正的妖股体验
  - 事件类型不同，波动幅度不同：
    - 打胶：0.5%-2% 微波动
    - 比划：1%-5% 小波动
    - 道具：2%-8% 中波动
    - 混沌风暴：5%-20% 大波动
    - 全局事件：10%-30% 剧烈波动
  - 股市行情显示最近事件动态
  - 命令：`牛牛股市`、`牛牛股市 购买 <金额>`、`牛牛股市 出售 [数量/全部]`、`牛牛股市 持仓`
  - 负数牛牛禁止进入股市

---

## [v2.0.9] - 2026-01-23

### 新增道具
- **牛牛均富/负卡** (1888金币): 发动共产主义！全群所有牛牛长度和硬度取平均值！
  - 效果：计算群内所有牛牛的平均长度和硬度，然后把所有人都设为平均值
  - 大佬血亏，负数狂喜，中间人不亏不赚
  - 最少需要3人才能发动
  - 显示变化最大的前5名亏损者和前5名受益者

---

## [v2.0.8] - 2026-01-23

### 显示优化
- **长度单位自动转换**: 当长度绝对值超过阈值时自动转换单位显示
  - ≥100cm 显示为 m（如 1.50m）
  - ≥1km (100000cm) 显示为 km（如 2.30km）
  - 负数显示带 (凹) 标记（如 -5.00m (凹)）
- **核心道具显示优化**: 赌徒硬币、月牙天冲等道具效果文案支持自动单位转换

---

## [v2.0.7] - 2026-01-23

### 机制完善
- **夺牛魔蝌蚪罐头负数支持**: 完善对负数牛牛的支持
  - **夺取(50%)**: 可夺取负数牛牛，吸收目标债务（自己变短），目标归零重获新生
  - **大自爆(20%)**: 负数用户可自爆，因祸得福归零，但不对别人造成伤害
  - **自爆归零(10%)**: 负数用户归零是因祸得福，专属趣味文案

### 代码重构
- **保险理赔逻辑统一**: 将比划和道具购买的保险理赔逻辑统一为 `check_insurance_claim` 方法
  - 支持直接修改 `group_data`（批量操作）或独立保存（比划场景）
  - 减少重复代码，便于维护

---

## [v2.0.6] - 2026-01-23

### Bug修复
- **上保险理赔不生效**: 修复被动受害者（如被月牙天冲、劫富济贫等攻击）的保险理赔金币被后续数据保存覆盖的问题
- **上保险理赔金币被覆盖**: 修复购买道具时触发自己保险理赔后，理赔金币被购买扣费逻辑覆盖的问题
  - 原因：扣费时使用的是购买前的金币数，不包含理赔金额
  - 修复：正确计算扣费后金币 = 购买前金币 - 道具价格 + 理赔金额

---

## [v2.0.5] - 2026-01-22

### 机制调整
- **牛牛寄生**: 改为指定目标寄生（原为随机）
  - 用法：`牛牛购买 18 @目标`
  - 不能寄生自己
  - 目标必须已注册牛牛

---

## [v2.0.4] - 2026-01-22

### 新增功能
- **牛牛寄生** (150金币): 在指定群友身上种下寄生牛牛
  - 触发条件：宿主增长超过自身绝对值长度的 5% 时
  - 抽取效果：抽取宿主 5% 绝对值长度 + 5% 硬度给受益者
  - 持续存在直到宿主购买驱牛药
  - 单一寄生机制：新寄生覆盖旧寄生（有专属文案）
  - 支持链式反应（A→B→C递归触发）

- **驱牛药** (75金币): 清除自己身上的寄生牛牛
  - 显示被清除的寄生牛牛来源

### 显示优化
- 我的牛牛：显示 `🦠【寄】寄生牛牛来自：{受益者名}`
- 牛牛排行榜：带寄生的用户显示 `【寄】` 标记
- 牛牛背包：显示寄生状态和清除提示

### 触发场景
寄生牛牛在以下场景检查触发：
- 打胶增益
- 比划获胜增益
- 混沌风暴增益
- 商城道具增益

---

## [v2.0.3] - 2026-01-22

### 新增功能
- **牛牛补贴**: 管理员可给指定用户补贴/扣除属性
  - 命令格式：`牛牛补贴 @用户 长度 硬度 金币`
  - 支持负数参数（倒扣）
  - 硬度最低为0，长度和金币可为负数（欠账）

---

## [v2.0.2] - 2026-01-21 道具系统大改版

### 新增道具
- **小蓝片** (200金币): 下次比划硬度视为100
- **牛牛黑洞** (300金币): 吸取5-15人各3-10%长度
  - 40% 全归使用者
  - 30% 一半喷射给路人
  - 20% 反噬自己
  - 10% 吃撑反喷（所有人反而变长）

### 删除道具
- 巴适得板生长素
- 不灭之握
- 阿姆斯特朗旋风喷射炮

### 道具调整
| 道具 | 原效果 | 新效果 |
|------|--------|--------|
| 巴黎牛家 | +3硬度 (50金币) | +10硬度, -1~10%长度 (200金币) |
| 淬火爪刀 | 额外掠夺10%长度 | 额外掠夺10%长度和10%硬度 |
| 夺牛魔蝌蚪罐头 | 50%夺取/20%清空/30%无效 | 50%夺取全部(长度+硬度)/20%混沌风暴/20%大自爆/10%自爆归零 |
| 赌徒硬币 | 50%翻倍/50%减半 | 50%翻倍/48%减半/1%头等奖(x4)/1%霉运(x-2) |
| 劫富济贫 | 抢15%长度 (300金币) | 抢50%长度+20%硬度 (600金币) |
| 牛牛盾牌 | 直接获得护盾 | 购买时扣除当前50%长度和硬度 |

### 数值调整
- 打胶早期增长上限: 5 → 10cm
- 打胶后期增长范围: 3-6 → 4-12cm

### Bug修复
- 修复开团发起者可能不在团内的问题
- 修复批量购买 `牛牛购买 1 2` 只买1个的问题
- 修复混沌连锁显示 `???` 的问题
- 修复护盾无法抵挡全局事件的问题

### 护盾机制完善
- 混沌风暴个人负面事件检查护盾
- 全局事件 (末日审判/反向天赋/团灭彩票) 检查护盾
- `chaos_tax` 不可被护盾抵挡（核心收益机制）

#### 护盾可抵挡的事件
| 类型 | 事件 | 效果 |
|------|------|------|
| 个人负面 | length_down | 长度-1~15cm |
| 个人负面 | hardness_down | 硬度-1~2 |
| 个人负面 | coin_lose | 失去10~50金币 |
| 个人负面 | length_percent_down | 长度-5~20% |
| 个人负面 | halve | 长度减半 |
| 个人负面 | give_to_random | 送给随机人3~10cm |
| 个人负面 | dark_sacrifice | 牺牲20%长度给别人x3 |
| 个人负面 | reverse_sign | 正负翻转（仅正数时） |
| 全局事件 | doomsday | 最短者归零（最短者可防护） |
| 全局事件 | reverse_talent | 最长最短互换（最长者可防护） |
| 全局事件 | lottery_bomb 95% | 全体-50%（每人单独检查） |
