# 比划比划机制完整文档

> 最后更新: 2026-01-19

---

## 1. 前置检查

| 检查项 | 条件 |
|--------|------|
| 插件启用 | `plugin_enabled = True` |
| 自身注册 | 用户必须已注册牛牛 |
| 目标指定 | 必须 @目标用户 |
| 目标注册 | 对方必须已注册牛牛 |
| 不能自比 | `target_id ≠ user_id` |
| 冷却时间 | 对同一目标有冷却 (`COMPARE_COOLDOWN`) |
| 频率限制 | **10分钟内最多比划3次** |

---

## 2. 胜率计算

```python
raw_prob = 50% + 长度因子 + 硬度因子
win_prob = clamp(raw_prob, 15%, 85%)  # 强制限制范围
```

> **重要**: 无论优势多大，胜率最高 85%；无论劣势多大，胜率最低 15%

### 长度因子 (最大 ±20%)

| 情况 | 计算 |
|------|------|
| 双方正数 | `(我方长度 - 对方长度) / max(双方长度) × 0.2` |
| 我凹对方正 | `-0.2` (极大劣势) |
| 我正对方凹 | `+0.2` (极大优势) |
| 双方都凹 | 谁更接近0谁有优势 |

### 硬度因子 (每级 8%)

```
hardness_factor = (我方硬度 - 对方硬度) × 0.08
```

- 硬度差 1 级 = ±8%
- 硬度差 5 级 = ±40%
- 硬度差 9 级 = ±72% (理论值，实际受 clamp 限制)

### 计算示例

| 场景 | 计算 | 结果 |
|------|------|------|
| 完全碾压 | 50% + 20% + 72% = 142% | **85%** (上限) |
| 完全劣势 | 50% - 20% - 72% = -42% | **15%** (下限) |
| 长度优势 + 硬度劣势 | 50% + 15% - 24% = 41% | **41%** |
| 势均力敌 | 50% + 0% + 0% = 50% | **50%** |

---

## 3. 伤害计算

### 基础值

- **增益 (gain)**: `random(0, 3)` cm
- **损失 (loss)**: `random(1, 2)` cm

### 硬度修正

| 角色 | 公式 | 说明 |
|------|------|------|
| **赢家攻击加成** | `+max(0, (赢家硬度-5) × 0.3)` | 硬度10 → +1cm |
| **输家防御减伤** | `-max(0, (输家硬度-5) × 0.2)` | 硬度10 → -1cm损失 (最低1) |

### 示例

- 硬度10打硬度1: 攻击+1，对方无减伤
- 硬度1打硬度10: 无加成，对方减伤1 (最低损失1)

---

## 4. 特殊奖励机制

### 极大劣势 + 硬度优势获胜

```
条件: 我方长度 < 对方长度 AND 差距 ≥ 20cm AND 我方硬度 > 对方硬度
奖励: 额外 +0~5cm
```

### 掠夺机制

```
条件: 长度差 > 10cm AND 我方更短 AND 对方长度 > 0
效果: 额外夺取对方长度的 20%
```

### 硬度优势获胜提示

```
条件: 长度差 ≤ 5cm AND 我方硬度 > 对方硬度
效果: 显示 "因硬度优势获胜！"
```

---

## 5. 硬度衰减

| 角色 | 概率 | 效果 |
|------|------|------|
| **赢家** | 0% | 不衰减 |
| **输家** | 15% | 硬度 -1 (最低1) |

衰减时会明确通知: `💪 xxx 硬度下降: 5 → 4`

---

## 6. 特殊事件 (互斥，按优先级)

### 基础特殊事件

| 事件 | 条件 | 概率 | 效果 |
|------|------|------|------|
| **势均力敌** | 长度差 ≤ 5cm | 7.5% | 仅提示，无额外效果 |
| **柔软缠绕** | 任一方硬度 ≤ 2 | 5% | 双方长度减半 |
| **神秘减半** | 长度差 < 10cm | 2.5% | 双方长度减半 |

> 减半事件可被「妙脆角」道具阻止

### 随机趣味事件

| 事件 | 条件 | 概率 | 效果 |
|------|------|------|------|
| **💥 暴击** | 赢家触发 | 3% | 对输家造成双倍伤害 |
| **💨 闪避** | 输家触发 | 3% | 输家免疫本次损失 |
| **🔄 反噬** | 无 | 2% | 双方的长度变化互换 |
| **🎊 双赢** | 无 | 2% | 双方都+2~5cm |
| **💪 硬度觉醒** | 赢家硬度 ≤ 3 | 5% | 赢家硬度+2 |
| **🔀 长度互换** | 长度差 > 30cm | 1% | 双方长度交换（混乱！）|
| **🍀 幸运一击** | 输家长度 < 5cm | 10% | 输家+5cm |

> 所有特殊事件互斥，每次比划最多触发一个

---

## 7. 道具效果触发点

| 触发点 | 时机 | 示例道具 |
|--------|------|----------|
| `BEFORE_COMPARE` | 比划开始前 | 夺牛魔 (拦截并反转) |
| `ON_COMPARE_WIN` | 获胜时 | 致命节奏 (额外增益) |
| `ON_COMPARE_LOSE` | 失败时 | 余震 (防止损失) |
| `ON_HALVING` | 减半事件时 | 妙脆角 (阻止减半) |

---

## 8. 输出格式

```
⚔️ 【牛牛对决结果】 ⚔️
🗡️ 发起者: 10cm → 13cm
🛡️ 目标: 20cm → 18cm
📢 🎉 发起者 战胜了 目标！增加 3cm
💪 目标 硬度下降: 5 → 4  (如有衰减)
🤝 双方势均力敌！ (如有特殊事件)
```

---

## 9. 流程图

```
开始
  ↓
前置检查 (注册/冷却/频率)
  ↓
触发 BEFORE_COMPARE 效果 → [被拦截?] → 结束
  ↓
计算胜率 = 50% + 长度因子 + 硬度因子 (clamp 15%-85%)
  ↓
随机判定胜负
  ↓
┌─────────────┬─────────────┐
│    获胜     │    失败     │
├─────────────┼─────────────┤
│ 触发 WIN 效果 │ 触发 LOSE 效果│
│ 计算硬度加成  │ 计算硬度减伤  │
│ 我方 +gain   │ 对方 +gain   │
│ 对方 -loss   │ 我方 -loss   │
│ 检查掠夺/劣势奖励│            │
└─────────────┴─────────────┘
  ↓
输家 15% 概率硬度衰减
  ↓
检查基础特殊事件 (势均力敌/缠绕/减半)
  ↓
检查随机趣味事件 (暴击/闪避/反噬/双赢/觉醒/互换/幸运)
  ↓
输出结果
```

---

## 10. 相关配置

硬度相关常量位于代码中：

| 参数 | 值 | 说明 |
|------|-----|------|
| 硬度范围 | 1-10 | 最低1，最高10 |
| 硬度胜率因子 | 0.08 | 每级硬度差影响8%胜率 |
| 硬度攻击系数 | 0.3 | `(硬度-5) × 0.3` 为攻击加成 |
| 硬度防御系数 | 0.2 | `(硬度-5) × 0.2` 为防御减伤 |
| 硬度衰减概率 | 15% | 仅输家触发 |
| 缠绕硬度阈值 | ≤2 | 硬度过低触发缠绕风险 |
